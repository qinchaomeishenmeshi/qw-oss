"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.TtOss = void 0;
var _aliOss = _interopRequireDefault(require("ali-oss"));
var _multipartUpload = require("./src/multipart-upload");
var _simpleUpload = require("./src/simple-upload");
var _thumb = require("./src/thumb");
var _name2Url = require("./src/name-2-url");
var _isOssUrl = require("./src/is-oss-url");
var _getRelativePathFromUrl = require("./src/get-relative-path-from-url");
var _isSupportWebp = require("./src/is-support-webp");
function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }
class TtOss {
  // 单例

  // TtOss的配置

  // ali-oss实例

  // 控制promise缓存,手动控制是因为ali-oss没有做promise缓存，多次同时请求时会请求多次接口

  // 控制缓存的标识
  isUpdatingOssClient = false;
  /**
   * @description: 安装方法
   * @param {options} 配置项
   * @return {TtOss} 单例
   */
  static install(options) {
    return new TtOss(options);
  }
  /**
   * @description: 重新安装方法,目前主要用于业务侧更新sts信息
   * @return {TtOss} 新的单例
   */
  static reinstall() {
    const TtOssOptions = this.getGlobalInstance().TtOssOptions;
    this.globalTtOssInstance = undefined;
    return new TtOss(TtOssOptions);
  }
  /**
   * @description: 获取单例
   * @return {TtOss} 单例
   */
  static getGlobalInstance() {
    if (!this.globalTtOssInstance) {
      throw new Error("请先初始化TtOss");
    }
    return this.globalTtOssInstance;
  }
  /**
   * @description: 业务上传
   * @param {File} file
   * @param {object} options
   * @return {Promise<OssUploadResponse>}
   */
  static upload(...args) {
    return this.getGlobalInstance().upload(...args);
  }
  /**
   * @description: 获取ali-oss实例
   * @return {Promise<AliOssInstance>}
   */
  static getOssClient() {
    return this.getGlobalInstance().getOssClient();
  }
  /**
   * @description: 对src或者oss的name进行签名，并增加缩放、格式等参数并签名
   * @param {string} src url或者oss的name
   * @param {object} options 配置项
   * @return {Promise<string>} 签名后的src
   */
  static thumb(...args) {
    return (0, _thumb.thumb)(...args);
  }
  /**
   * @description: oss返回的文件name转换成url
   * @param {string} src oss的name
   * @return {Promise<string>} 签名后的src
   */
  static name2Url(...args) {
    return (0, _name2Url.name2Url)(...args);
  }
  // 是否是oss的url
  /**
   * @description: oss返回的文件name转换成url
   * @param {string} src oss的name
   * @return {Promise<string>} 签名后的src
   */
  static isOssUrl(...args) {
    return (0, _isOssUrl.isOssUrl)(...args);
  }
  /**
   * @description: 是否是需要签名的url
   * @param {string} url
   * @return {boolean}
   */
  static isNeedSignOssUrl(...args) {
    return (0, _isOssUrl.isNeedSignOssUrl)(...args);
  }
  /**
   * @description: 截取oss的url，只保留name
   * @param {string} url
   * @return {string}
   */
  static getRelativePathFromUrl(...args) {
    return (0, _getRelativePathFromUrl.getRelativePathFromUrl)(...args);
  }
  // 获取oss的imageMIME，支持webp格式就返回webp
  static getOssImageMIME(...args) {
    return (0, _isSupportWebp.getOssImageMIME)(...args);
  }
  constructor(options) {
    if (TtOss.globalTtOssInstance) return TtOss.globalTtOssInstance;
    this.TtOssOptions = options;
    TtOss.globalTtOssInstance = this;
  }
  /**
   * @description: 业务上传（实例方法）
   * @param {File} file
   * @param {object} options
   * @return {Promise<OssUploadResponse>}
   */
  upload(file, options) {
    if (!options) return (0, _multipartUpload.multipartUpload)(file);else if ("chunked" in options) {
      if (options.chunked) return (0, _multipartUpload.multipartUpload)(file, options);else return (0, _simpleUpload.simpleUpload)(file, options);
    } else return (0, _multipartUpload.multipartUpload)(file, options);
  }
  /**
   * @description: 获取ali-oss实例（实例方法）
   * @return {Promise<AliOssInstance>}
   */
  getOssClient() {
    const getCurrentOssClientPromise = async () => {
      if (!this.currentOssClientPromise) {
        this.initOssClient();
        // 原本逻辑是30秒冗余时间，但是发现接口的expiration不是每次请求刷新，所以改为以下逻辑
      } else if (this.aliOssClient?.options?.expiration < Date.now()) {
        this.updateOssClient();
      }
      return this.currentOssClientPromise;
    };
    return getCurrentOssClientPromise();
  }

  // 设置ali-oss实例
  async setAliOssClient() {
    const ossClientOptions = await this.TtOssOptions2AliOssOptions();
    this.aliOssClient = new _aliOss.default(ossClientOptions);
    this.isUpdatingOssClient = false;
    return this.aliOssClient;
  }
  // 第一次初始化
  initOssClient() {
    if (this.isUpdatingOssClient) return;
    this.isUpdatingOssClient = true;
    this.currentOssClientPromise = this.setAliOssClient();
  }
  // 后续过期判断
  updateOssClient() {
    if (this.isUpdatingOssClient) return;
    this.isUpdatingOssClient = true;
    this.currentOssClientPromise = this.setAliOssClient();
  }
  // TtOss配置项=>ali-oss配置项
  async TtOssOptions2AliOssOptions() {
    if (this.isTtOssOptionsWithFetch(this.TtOssOptions)) {
      const ossApiInfo = await this.TtOssOptions.fetchOssInfo();
      const ossClientOptions = this.ossApiInfo2OssClientOptions(ossApiInfo);
      return ossClientOptions;
    } else if (this.isTtOssOptionsWithApi(this.TtOssOptions)) {
      const ossClientOptions = this.ossApiInfo2OssClientOptions(this.TtOssOptions);
      return ossClientOptions;
    } else {
      return this.TtOssOptions;
    }
  }
  // 接口oss信息=>前端需要的信息
  ossApiInfo2OssClientOptions(ossApiInfo) {
    const {
      accessKeyId,
      accessKeySecret,
      regionId,
      bucketName,
      securityToken,
      expiration
    } = ossApiInfo;
    return {
      expiration,
      // 接口返回，ali-oss不需要
      accessKeyId,
      accessKeySecret,
      region: `oss-${regionId}`,
      bucket: bucketName,
      stsToken: securityToken
    };
  }
  isTtOssOptionsWithFetch(options) {
    return !!options.fetchOssInfo;
  }
  isTtOssOptionsWithApi(options) {
    return !!options.securityToken;
  }
}
exports.TtOss = TtOss;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJUdE9zcyIsImlzVXBkYXRpbmdPc3NDbGllbnQiLCJpbnN0YWxsIiwib3B0aW9ucyIsInJlaW5zdGFsbCIsIlR0T3NzT3B0aW9ucyIsImdldEdsb2JhbEluc3RhbmNlIiwiZ2xvYmFsVHRPc3NJbnN0YW5jZSIsInVuZGVmaW5lZCIsIkVycm9yIiwidXBsb2FkIiwiYXJncyIsImdldE9zc0NsaWVudCIsInRodW1iIiwibmFtZTJVcmwiLCJpc09zc1VybCIsImlzTmVlZFNpZ25Pc3NVcmwiLCJnZXRSZWxhdGl2ZVBhdGhGcm9tVXJsIiwiZ2V0T3NzSW1hZ2VNSU1FIiwiY29uc3RydWN0b3IiLCJmaWxlIiwibXVsdGlwYXJ0VXBsb2FkIiwiY2h1bmtlZCIsInNpbXBsZVVwbG9hZCIsImdldEN1cnJlbnRPc3NDbGllbnRQcm9taXNlIiwiY3VycmVudE9zc0NsaWVudFByb21pc2UiLCJpbml0T3NzQ2xpZW50IiwiYWxpT3NzQ2xpZW50IiwiZXhwaXJhdGlvbiIsIkRhdGUiLCJub3ciLCJ1cGRhdGVPc3NDbGllbnQiLCJzZXRBbGlPc3NDbGllbnQiLCJvc3NDbGllbnRPcHRpb25zIiwiVHRPc3NPcHRpb25zMkFsaU9zc09wdGlvbnMiLCJPc3MiLCJpc1R0T3NzT3B0aW9uc1dpdGhGZXRjaCIsIm9zc0FwaUluZm8iLCJmZXRjaE9zc0luZm8iLCJvc3NBcGlJbmZvMk9zc0NsaWVudE9wdGlvbnMiLCJpc1R0T3NzT3B0aW9uc1dpdGhBcGkiLCJhY2Nlc3NLZXlJZCIsImFjY2Vzc0tleVNlY3JldCIsInJlZ2lvbklkIiwiYnVja2V0TmFtZSIsInNlY3VyaXR5VG9rZW4iLCJyZWdpb24iLCJidWNrZXQiLCJzdHNUb2tlbiJdLCJzb3VyY2VzIjpbIi4uL2xpYlNyYy9jbGFzcy50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgT3NzIGZyb20gXCJhbGktb3NzXCI7XG5pbXBvcnQge1xuICBUdE9zc09wdGlvbnMsXG4gIFR0T3NzT3B0aW9uc1dpdGhGZXRjaCwgXG4gIFR0T3NzT3B0aW9uc1dpdGhBcGksXG59IGZyb20gXCIuL3R5cGluZ3NcIjtcbmltcG9ydCB7IEFsaU9zc0luc3RhbmNlLCBPc3NBcGlJbmZvIH0gZnJvbSBcIi4vdHlwaW5nc1wiO1xuaW1wb3J0IHsgbXVsdGlwYXJ0VXBsb2FkIH0gZnJvbSBcIi4vc3JjL211bHRpcGFydC11cGxvYWRcIjtcbmltcG9ydCB7IHNpbXBsZVVwbG9hZCB9IGZyb20gXCIuL3NyYy9zaW1wbGUtdXBsb2FkXCI7XG5pbXBvcnQgeyB0aHVtYiB9IGZyb20gXCIuL3NyYy90aHVtYlwiO1xuaW1wb3J0IHsgbmFtZTJVcmwgfSBmcm9tIFwiLi9zcmMvbmFtZS0yLXVybFwiO1xuaW1wb3J0IHsgaXNOZWVkU2lnbk9zc1VybCwgaXNPc3NVcmwgfSBmcm9tIFwiLi9zcmMvaXMtb3NzLXVybFwiO1xuaW1wb3J0IHsgZ2V0UmVsYXRpdmVQYXRoRnJvbVVybCB9IGZyb20gXCIuL3NyYy9nZXQtcmVsYXRpdmUtcGF0aC1mcm9tLXVybFwiO1xuaW1wb3J0IHsgZ2V0T3NzSW1hZ2VNSU1FIH0gZnJvbSBcIi4vc3JjL2lzLXN1cHBvcnQtd2VicFwiO1xuXG5leHBvcnQgY2xhc3MgVHRPc3Mge1xuICAvLyDljZXkvotcbiAgcHJpdmF0ZSBzdGF0aWMgZ2xvYmFsVHRPc3NJbnN0YW5jZTogVHRPc3MgfCB1bmRlZmluZWQ7XG4gIC8vIFR0T3Nz55qE6YWN572uXG4gIFR0T3NzT3B0aW9ucyE6IFR0T3NzT3B0aW9ucztcbiAgLy8gYWxpLW9zc+WunuS+i1xuICBhbGlPc3NDbGllbnQhOiBBbGlPc3NJbnN0YW5jZTtcbiAgLy8g5o6n5Yi2cHJvbWlzZee8k+WtmCzmiYvliqjmjqfliLbmmK/lm6DkuLphbGktb3Nz5rKh5pyJ5YGacHJvbWlzZee8k+WtmO+8jOWkmuasoeWQjOaXtuivt+axguaXtuS8muivt+axguWkmuasoeaOpeWPo1xuICBwcml2YXRlIGN1cnJlbnRPc3NDbGllbnRQcm9taXNlPzogUHJvbWlzZTxBbGlPc3NJbnN0YW5jZT47XG4gIC8vIOaOp+WItue8k+WtmOeahOagh+ivhlxuICBwcml2YXRlIGlzVXBkYXRpbmdPc3NDbGllbnQgPSBmYWxzZTtcbiAgLyoqXG4gICAqIEBkZXNjcmlwdGlvbjog5a6J6KOF5pa55rOVXG4gICAqIEBwYXJhbSB7b3B0aW9uc30g6YWN572u6aG5XG4gICAqIEByZXR1cm4ge1R0T3NzfSDljZXkvotcbiAgICovXG4gIHN0YXRpYyBpbnN0YWxsKG9wdGlvbnM6IFR0T3NzT3B0aW9ucykge1xuICAgIHJldHVybiBuZXcgVHRPc3Mob3B0aW9ucyk7XG4gIH1cbiAgLyoqXG4gICAqIEBkZXNjcmlwdGlvbjog6YeN5paw5a6J6KOF5pa55rOVLOebruWJjeS4u+imgeeUqOS6juS4muWKoeS+p+abtOaWsHN0c+S/oeaBr1xuICAgKiBAcmV0dXJuIHtUdE9zc30g5paw55qE5Y2V5L6LXG4gICAqL1xuICBzdGF0aWMgcmVpbnN0YWxsKCkge1xuICAgIGNvbnN0IFR0T3NzT3B0aW9ucyA9IHRoaXMuZ2V0R2xvYmFsSW5zdGFuY2UoKS5UdE9zc09wdGlvbnM7XG4gICAgdGhpcy5nbG9iYWxUdE9zc0luc3RhbmNlID0gdW5kZWZpbmVkO1xuICAgIHJldHVybiBuZXcgVHRPc3MoVHRPc3NPcHRpb25zKTtcbiAgfVxuICAvKipcbiAgICogQGRlc2NyaXB0aW9uOiDojrflj5bljZXkvotcbiAgICogQHJldHVybiB7VHRPc3N9IOWNleS+i1xuICAgKi9cbiAgc3RhdGljIGdldEdsb2JhbEluc3RhbmNlKCkge1xuICAgIGlmICghdGhpcy5nbG9iYWxUdE9zc0luc3RhbmNlKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXCLor7flhYjliJ3lp4vljJZUdE9zc1wiKTtcbiAgICB9XG4gICAgcmV0dXJuIHRoaXMuZ2xvYmFsVHRPc3NJbnN0YW5jZTtcbiAgfVxuICAvKipcbiAgICogQGRlc2NyaXB0aW9uOiDkuJrliqHkuIrkvKBcbiAgICogQHBhcmFtIHtGaWxlfSBmaWxlXG4gICAqIEBwYXJhbSB7b2JqZWN0fSBvcHRpb25zXG4gICAqIEByZXR1cm4ge1Byb21pc2U8T3NzVXBsb2FkUmVzcG9uc2U+fVxuICAgKi9cbiAgc3RhdGljIHVwbG9hZCguLi5hcmdzOiBQYXJhbWV0ZXJzPFR0T3NzW1widXBsb2FkXCJdPikge1xuICAgIHJldHVybiB0aGlzLmdldEdsb2JhbEluc3RhbmNlKCkudXBsb2FkKC4uLmFyZ3MpO1xuICB9XG4gIC8qKlxuICAgKiBAZGVzY3JpcHRpb246IOiOt+WPlmFsaS1vc3Plrp7kvotcbiAgICogQHJldHVybiB7UHJvbWlzZTxBbGlPc3NJbnN0YW5jZT59XG4gICAqL1xuICBzdGF0aWMgZ2V0T3NzQ2xpZW50KCkge1xuICAgIHJldHVybiB0aGlzLmdldEdsb2JhbEluc3RhbmNlKCkuZ2V0T3NzQ2xpZW50KCk7XG4gIH1cbiAgLyoqXG4gICAqIEBkZXNjcmlwdGlvbjog5a+5c3Jj5oiW6ICFb3Nz55qEbmFtZei/m+ihjOetvuWQje+8jOW5tuWinuWKoOe8qeaUvuOAgeagvOW8j+etieWPguaVsOW5tuetvuWQjVxuICAgKiBAcGFyYW0ge3N0cmluZ30gc3JjIHVybOaIluiAhW9zc+eahG5hbWVcbiAgICogQHBhcmFtIHtvYmplY3R9IG9wdGlvbnMg6YWN572u6aG5XG4gICAqIEByZXR1cm4ge1Byb21pc2U8c3RyaW5nPn0g562+5ZCN5ZCO55qEc3JjXG4gICAqL1xuICBzdGF0aWMgdGh1bWIoLi4uYXJnczogUGFyYW1ldGVyczx0eXBlb2YgdGh1bWI+KSB7XG4gICAgcmV0dXJuIHRodW1iKC4uLmFyZ3MpO1xuICB9XG4gIC8qKlxuICAgKiBAZGVzY3JpcHRpb246IG9zc+i/lOWbnueahOaWh+S7tm5hbWXovazmjaLmiJB1cmxcbiAgICogQHBhcmFtIHtzdHJpbmd9IHNyYyBvc3PnmoRuYW1lXG4gICAqIEByZXR1cm4ge1Byb21pc2U8c3RyaW5nPn0g562+5ZCN5ZCO55qEc3JjXG4gICAqL1xuICBzdGF0aWMgbmFtZTJVcmwoLi4uYXJnczogUGFyYW1ldGVyczx0eXBlb2YgbmFtZTJVcmw+KSB7XG4gICAgcmV0dXJuIG5hbWUyVXJsKC4uLmFyZ3MpO1xuICB9XG4gIC8vIOaYr+WQpuaYr29zc+eahHVybFxuICAvKipcbiAgICogQGRlc2NyaXB0aW9uOiBvc3Pov5Tlm57nmoTmlofku7ZuYW1l6L2s5o2i5oiQdXJsXG4gICAqIEBwYXJhbSB7c3RyaW5nfSBzcmMgb3Nz55qEbmFtZVxuICAgKiBAcmV0dXJuIHtQcm9taXNlPHN0cmluZz59IOetvuWQjeWQjueahHNyY1xuICAgKi9cbiAgc3RhdGljIGlzT3NzVXJsKC4uLmFyZ3M6IFBhcmFtZXRlcnM8dHlwZW9mIGlzT3NzVXJsPikge1xuICAgIHJldHVybiBpc09zc1VybCguLi5hcmdzKTtcbiAgfVxuICAvKipcbiAgICogQGRlc2NyaXB0aW9uOiDmmK/lkKbmmK/pnIDopoHnrb7lkI3nmoR1cmxcbiAgICogQHBhcmFtIHtzdHJpbmd9IHVybFxuICAgKiBAcmV0dXJuIHtib29sZWFufVxuICAgKi9cbiAgc3RhdGljIGlzTmVlZFNpZ25Pc3NVcmwoLi4uYXJnczogUGFyYW1ldGVyczx0eXBlb2YgaXNOZWVkU2lnbk9zc1VybD4pIHtcbiAgICByZXR1cm4gaXNOZWVkU2lnbk9zc1VybCguLi5hcmdzKTtcbiAgfVxuICAvKipcbiAgICogQGRlc2NyaXB0aW9uOiDmiKrlj5Zvc3PnmoR1cmzvvIzlj6rkv53nlZluYW1lXG4gICAqIEBwYXJhbSB7c3RyaW5nfSB1cmxcbiAgICogQHJldHVybiB7c3RyaW5nfVxuICAgKi9cbiAgc3RhdGljIGdldFJlbGF0aXZlUGF0aEZyb21VcmwoXG4gICAgLi4uYXJnczogUGFyYW1ldGVyczx0eXBlb2YgZ2V0UmVsYXRpdmVQYXRoRnJvbVVybD5cbiAgKSB7XG4gICAgcmV0dXJuIGdldFJlbGF0aXZlUGF0aEZyb21VcmwoLi4uYXJncyk7XG4gIH1cbiAgLy8g6I635Y+Wb3Nz55qEaW1hZ2VNSU1F77yM5pSv5oyBd2VicOagvOW8j+Wwsei/lOWbnndlYnBcbiAgc3RhdGljIGdldE9zc0ltYWdlTUlNRSguLi5hcmdzOiBQYXJhbWV0ZXJzPHR5cGVvZiBnZXRPc3NJbWFnZU1JTUU+KSB7XG4gICAgcmV0dXJuIGdldE9zc0ltYWdlTUlNRSguLi5hcmdzKTtcbiAgfVxuICBjb25zdHJ1Y3RvcihvcHRpb25zOiBUdE9zc09wdGlvbnMpIHtcbiAgICBpZiAoVHRPc3MuZ2xvYmFsVHRPc3NJbnN0YW5jZSkgcmV0dXJuIFR0T3NzLmdsb2JhbFR0T3NzSW5zdGFuY2U7XG4gICAgdGhpcy5UdE9zc09wdGlvbnMgPSBvcHRpb25zO1xuICAgIFR0T3NzLmdsb2JhbFR0T3NzSW5zdGFuY2UgPSB0aGlzO1xuICB9XG4gIC8qKlxuICAgKiBAZGVzY3JpcHRpb246IOS4muWKoeS4iuS8oO+8iOWunuS+i+aWueazle+8iVxuICAgKiBAcGFyYW0ge0ZpbGV9IGZpbGVcbiAgICogQHBhcmFtIHtvYmplY3R9IG9wdGlvbnNcbiAgICogQHJldHVybiB7UHJvbWlzZTxPc3NVcGxvYWRSZXNwb25zZT59XG4gICAqL1xuICB1cGxvYWQoXG4gICAgZmlsZTogRmlsZSxcbiAgICBvcHRpb25zPzogKFxuICAgICAgfCBQYXJhbWV0ZXJzPHR5cGVvZiBzaW1wbGVVcGxvYWQ+WzFdXG4gICAgICB8IFBhcmFtZXRlcnM8dHlwZW9mIG11bHRpcGFydFVwbG9hZD5bMV1cbiAgICApICYgeyBjaHVuaz86IGJvb2xlYW4gfVxuICApIHtcbiAgICBpZiAoIW9wdGlvbnMpIHJldHVybiBtdWx0aXBhcnRVcGxvYWQoZmlsZSk7XG4gICAgZWxzZSBpZiAoXCJjaHVua2VkXCIgaW4gb3B0aW9ucykge1xuICAgICAgaWYgKG9wdGlvbnMuY2h1bmtlZCkgcmV0dXJuIG11bHRpcGFydFVwbG9hZChmaWxlLCBvcHRpb25zKTtcbiAgICAgIGVsc2UgcmV0dXJuIHNpbXBsZVVwbG9hZChmaWxlLCBvcHRpb25zKTtcbiAgICB9IGVsc2UgcmV0dXJuIG11bHRpcGFydFVwbG9hZChmaWxlLCBvcHRpb25zKTtcbiAgfVxuICAvKipcbiAgICogQGRlc2NyaXB0aW9uOiDojrflj5ZhbGktb3Nz5a6e5L6L77yI5a6e5L6L5pa55rOV77yJXG4gICAqIEByZXR1cm4ge1Byb21pc2U8QWxpT3NzSW5zdGFuY2U+fVxuICAgKi9cbiAgZ2V0T3NzQ2xpZW50KCkge1xuICAgIGNvbnN0IGdldEN1cnJlbnRPc3NDbGllbnRQcm9taXNlID0gYXN5bmMgKCkgPT4ge1xuICAgICAgaWYgKCF0aGlzLmN1cnJlbnRPc3NDbGllbnRQcm9taXNlKSB7XG4gICAgICAgIHRoaXMuaW5pdE9zc0NsaWVudCgpO1xuICAgICAgICAvLyDljp/mnKzpgLvovpHmmK8zMOenkuWGl+S9meaXtumXtO+8jOS9huaYr+WPkeeOsOaOpeWPo+eahGV4cGlyYXRpb27kuI3mmK/mr4/mrKHor7fmsYLliLfmlrDvvIzmiYDku6XmlLnkuLrku6XkuIvpgLvovpFcbiAgICAgIH0gZWxzZSBpZiAodGhpcy5hbGlPc3NDbGllbnQ/Lm9wdGlvbnM/LmV4cGlyYXRpb24hIDwgRGF0ZS5ub3coKSkge1xuICAgICAgICB0aGlzLnVwZGF0ZU9zc0NsaWVudCgpO1xuICAgICAgfVxuICAgICAgcmV0dXJuIHRoaXMuY3VycmVudE9zc0NsaWVudFByb21pc2UhO1xuICAgIH07XG4gICAgcmV0dXJuIGdldEN1cnJlbnRPc3NDbGllbnRQcm9taXNlKCk7XG4gIH1cblxuICAvLyDorr7nva5hbGktb3Nz5a6e5L6LXG4gIHByaXZhdGUgYXN5bmMgc2V0QWxpT3NzQ2xpZW50KCkge1xuICAgIGNvbnN0IG9zc0NsaWVudE9wdGlvbnMgPSBhd2FpdCB0aGlzLlR0T3NzT3B0aW9uczJBbGlPc3NPcHRpb25zKCk7XG4gICAgdGhpcy5hbGlPc3NDbGllbnQgPSBuZXcgT3NzKG9zc0NsaWVudE9wdGlvbnMpO1xuICAgIHRoaXMuaXNVcGRhdGluZ09zc0NsaWVudCA9IGZhbHNlO1xuICAgIHJldHVybiB0aGlzLmFsaU9zc0NsaWVudDtcbiAgfVxuICAvLyDnrKzkuIDmrKHliJ3lp4vljJZcbiAgcHJpdmF0ZSBpbml0T3NzQ2xpZW50KCkge1xuICAgIGlmICh0aGlzLmlzVXBkYXRpbmdPc3NDbGllbnQpIHJldHVybjtcbiAgICB0aGlzLmlzVXBkYXRpbmdPc3NDbGllbnQgPSB0cnVlO1xuICAgIHRoaXMuY3VycmVudE9zc0NsaWVudFByb21pc2UgPSB0aGlzLnNldEFsaU9zc0NsaWVudCgpO1xuICB9XG4gIC8vIOWQjue7rei/h+acn+WIpOaWrVxuICBwcml2YXRlIHVwZGF0ZU9zc0NsaWVudCgpIHtcbiAgICBpZiAodGhpcy5pc1VwZGF0aW5nT3NzQ2xpZW50KSByZXR1cm47XG4gICAgdGhpcy5pc1VwZGF0aW5nT3NzQ2xpZW50ID0gdHJ1ZTtcbiAgICB0aGlzLmN1cnJlbnRPc3NDbGllbnRQcm9taXNlID0gdGhpcy5zZXRBbGlPc3NDbGllbnQoKTtcbiAgfVxuICAvLyBUdE9zc+mFjee9rumhuT0+YWxpLW9zc+mFjee9rumhuVxuICBhc3luYyBUdE9zc09wdGlvbnMyQWxpT3NzT3B0aW9ucygpIHtcbiAgICBpZiAodGhpcy5pc1R0T3NzT3B0aW9uc1dpdGhGZXRjaCh0aGlzLlR0T3NzT3B0aW9ucykpIHtcbiAgICAgIGNvbnN0IG9zc0FwaUluZm8gPSBhd2FpdCB0aGlzLlR0T3NzT3B0aW9ucy5mZXRjaE9zc0luZm8oKTtcbiAgICAgIGNvbnN0IG9zc0NsaWVudE9wdGlvbnMgPSB0aGlzLm9zc0FwaUluZm8yT3NzQ2xpZW50T3B0aW9ucyhvc3NBcGlJbmZvKTtcbiAgICAgIHJldHVybiBvc3NDbGllbnRPcHRpb25zO1xuICAgIH0gZWxzZSBpZiAodGhpcy5pc1R0T3NzT3B0aW9uc1dpdGhBcGkodGhpcy5UdE9zc09wdGlvbnMpKSB7XG4gICAgICBjb25zdCBvc3NDbGllbnRPcHRpb25zID0gdGhpcy5vc3NBcGlJbmZvMk9zc0NsaWVudE9wdGlvbnMoXG4gICAgICAgIHRoaXMuVHRPc3NPcHRpb25zXG4gICAgICApO1xuICAgICAgcmV0dXJuIG9zc0NsaWVudE9wdGlvbnM7XG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiB0aGlzLlR0T3NzT3B0aW9ucztcbiAgICB9XG4gIH1cbiAgLy8g5o6l5Y+jb3Nz5L+h5oGvPT7liY3nq6/pnIDopoHnmoTkv6Hmga9cbiAgb3NzQXBpSW5mbzJPc3NDbGllbnRPcHRpb25zKG9zc0FwaUluZm86IE9zc0FwaUluZm8pIHtcbiAgICBjb25zdCB7XG4gICAgICBhY2Nlc3NLZXlJZCxcbiAgICAgIGFjY2Vzc0tleVNlY3JldCxcbiAgICAgIHJlZ2lvbklkLFxuICAgICAgYnVja2V0TmFtZSxcbiAgICAgIHNlY3VyaXR5VG9rZW4sXG4gICAgICBleHBpcmF0aW9uLFxuICAgIH0gPSBvc3NBcGlJbmZvO1xuICAgIHJldHVybiB7XG4gICAgICBleHBpcmF0aW9uLCAvLyDmjqXlj6Pov5Tlm57vvIxhbGktb3Nz5LiN6ZyA6KaBXG4gICAgICBhY2Nlc3NLZXlJZCxcbiAgICAgIGFjY2Vzc0tleVNlY3JldCxcbiAgICAgIHJlZ2lvbjogYG9zcy0ke3JlZ2lvbklkfWAsXG4gICAgICBidWNrZXQ6IGJ1Y2tldE5hbWUsXG4gICAgICBzdHNUb2tlbjogc2VjdXJpdHlUb2tlbixcbiAgICB9O1xuICB9XG4gIHByaXZhdGUgaXNUdE9zc09wdGlvbnNXaXRoRmV0Y2goXG4gICAgb3B0aW9uczogVHRPc3NPcHRpb25zXG4gICk6IG9wdGlvbnMgaXMgVHRPc3NPcHRpb25zV2l0aEZldGNoIHtcbiAgICByZXR1cm4gISEob3B0aW9ucyBhcyBUdE9zc09wdGlvbnNXaXRoRmV0Y2gpLmZldGNoT3NzSW5mbztcbiAgfVxuXG4gIHByaXZhdGUgaXNUdE9zc09wdGlvbnNXaXRoQXBpKFxuICAgIG9wdGlvbnM6IFR0T3NzT3B0aW9uc1xuICApOiBvcHRpb25zIGlzIFR0T3NzT3B0aW9uc1dpdGhBcGkge1xuICAgIHJldHVybiAhIShvcHRpb25zIGFzIFR0T3NzT3B0aW9uc1dpdGhBcGkpLnNlY3VyaXR5VG9rZW47XG4gIH1cbn1cbiJdLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBQUE7QUFPQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUF3RDtBQUVqRCxNQUFNQSxL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