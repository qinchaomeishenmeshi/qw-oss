"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.QwOss = void 0;
var _aliOss = _interopRequireDefault(require("ali-oss"));
var _multipartUpload = require("./src/multipart-upload");
var _simpleUpload = require("./src/simple-upload");
var _thumb = require("./src/thumb");
var _name2Url = require("./src/name-2-url");
var _isOssUrl = require("./src/is-oss-url");
var _getRelativePathFromUrl = require("./src/get-relative-path-from-url");
var _isSupportWebp = require("./src/is-support-webp");
function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }
class QwOss {
  // 单例

  // TtOss的配置

  // ali-oss实例

  // 控制promise缓存,手动控制是因为ali-oss没有做promise缓存，多次同时请求时会请求多次接口

  // 控制缓存的标识
  isUpdatingOssClient = false;
  /**
   * @description: 安装方法
   * @param {options} 配置项
   * @return {QwOss} 单例
   */
  static install(options) {
    return new QwOss(options);
  }
  /**
   * @description: 重新安装方法,目前主要用于业务侧更新sts信息
   * @return {QwOss} 新的单例
   */
  static reinstall() {
    const TtOssOptions = this.getGlobalInstance().TtOssOptions;
    this.globalTtOssInstance = undefined;
    return new QwOss(TtOssOptions);
  }
  /**
   * @description: 获取单例
   * @return {QwOss} 单例
   */
  static getGlobalInstance() {
    if (!this.globalTtOssInstance) {
      throw new Error('请先初始化TtOss');
    }
    return this.globalTtOssInstance;
  }
  /**
   * @description: 业务上传
   * @param {File} file
   * @param {object} options
   * @return {Promise<OssUploadResponse>}
   */
  static upload(...args) {
    return this.getGlobalInstance().upload(...args);
  }
  /**
   * @description: 获取ali-oss实例
   * @return {Promise<AliOssInstance>}
   */
  static getOssClient() {
    return this.getGlobalInstance().getOssClient();
  }
  /**
   * @description: 对src或者oss的name进行签名，并增加缩放、格式等参数并签名
   * @param {string} src url或者oss的name
   * @param {object} options 配置项
   * @return {Promise<string>} 签名后的src
   */
  static thumb(...args) {
    return (0, _thumb.thumb)(...args);
  }
  /**
   * @description: oss返回的文件name转换成url
   * @param {string} src oss的name
   * @return {Promise<string>} 签名后的src
   */
  static name2Url(...args) {
    return (0, _name2Url.name2Url)(...args);
  }
  // 是否是oss的url
  /**
   * @description: oss返回的文件name转换成url
   * @param {string} src oss的name
   * @return {Promise<string>} 签名后的src
   */
  static isOssUrl(...args) {
    return (0, _isOssUrl.isOssUrl)(...args);
  }
  /**
   * @description: 是否是需要签名的url
   * @param {string} url
   * @return {boolean}
   */
  static isNeedSignOssUrl(...args) {
    return (0, _isOssUrl.isNeedSignOssUrl)(...args);
  }
  /**
   * @description: 截取oss的url，只保留name
   * @param {string} url
   * @return {string}
   */
  static getRelativePathFromUrl(...args) {
    return (0, _getRelativePathFromUrl.getRelativePathFromUrl)(...args);
  }
  // 获取oss的imageMIME，支持webp格式就返回webp
  static getOssImageMIME(...args) {
    return (0, _isSupportWebp.getOssImageMIME)(...args);
  }
  constructor(options) {
    if (QwOss.globalTtOssInstance) return QwOss.globalTtOssInstance;
    this.TtOssOptions = options;
    QwOss.globalTtOssInstance = this;
  }
  /**
   * @description: 业务上传（实例方法）
   * @param {File} file
   * @param {object} options
   * @return {Promise<OssUploadResponse>}
   */
  upload(file, options) {
    if (!options) return (0, _multipartUpload.multipartUpload)(file);else if ('chunked' in options) {
      if (options.chunked) return (0, _multipartUpload.multipartUpload)(file, options);else return (0, _simpleUpload.simpleUpload)(file, options);
    } else return (0, _multipartUpload.multipartUpload)(file, options);
  }
  /**
   * @description: 获取ali-oss实例（实例方法）
   * @return {Promise<AliOssInstance>}
   */
  getOssClient() {
    const getCurrentOssClientPromise = async () => {
      if (!this.currentOssClientPromise) {
        this.initOssClient();
        // 原本逻辑是30秒冗余时间，但是发现接口的expiration不是每次请求刷新，所以改为以下逻辑
      } else if (this.aliOssClient?.options?.expiration < Date.now()) {
        this.updateOssClient();
      }
      return this.currentOssClientPromise;
    };
    return getCurrentOssClientPromise();
  }

  // 设置ali-oss实例
  async setAliOssClient() {
    const ossClientOptions = await this.TtOssOptions2AliOssOptions();
    this.aliOssClient = new _aliOss.default(ossClientOptions);
    this.isUpdatingOssClient = false;
    return this.aliOssClient;
  }
  // 第一次初始化
  initOssClient() {
    if (this.isUpdatingOssClient) return;
    this.isUpdatingOssClient = true;
    this.currentOssClientPromise = this.setAliOssClient();
  }
  // 后续过期判断
  updateOssClient() {
    if (this.isUpdatingOssClient) return;
    this.isUpdatingOssClient = true;
    this.currentOssClientPromise = this.setAliOssClient();
  }
  // TtOss配置项=>ali-oss配置项
  async TtOssOptions2AliOssOptions() {
    if (this.isTtOssOptionsWithFetch(this.TtOssOptions)) {
      const ossApiInfo = await this.TtOssOptions.fetchOssInfo();
      const ossClientOptions = this.ossApiInfo2OssClientOptions(ossApiInfo);
      return ossClientOptions;
    } else if (this.isTtOssOptionsWithApi(this.TtOssOptions)) {
      const ossClientOptions = this.ossApiInfo2OssClientOptions(this.TtOssOptions);
      return ossClientOptions;
    } else {
      return this.TtOssOptions;
    }
  }
  // 接口oss信息=>前端需要的信息
  ossApiInfo2OssClientOptions(ossApiInfo) {
    const {
      accessKeyId,
      accessKeySecret,
      regionId,
      bucketName,
      securityToken,
      expiration
    } = ossApiInfo;
    return {
      expiration,
      // 接口返回，ali-oss不需要
      accessKeyId,
      accessKeySecret,
      region: `oss-${regionId}`,
      bucket: bucketName,
      stsToken: securityToken
    };
  }
  isTtOssOptionsWithFetch(options) {
    return !!options.fetchOssInfo;
  }
  isTtOssOptionsWithApi(options) {
    return !!options.securityToken;
  }
}
exports.QwOss = QwOss;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJRd09zcyIsImlzVXBkYXRpbmdPc3NDbGllbnQiLCJpbnN0YWxsIiwib3B0aW9ucyIsInJlaW5zdGFsbCIsIlR0T3NzT3B0aW9ucyIsImdldEdsb2JhbEluc3RhbmNlIiwiZ2xvYmFsVHRPc3NJbnN0YW5jZSIsInVuZGVmaW5lZCIsIkVycm9yIiwidXBsb2FkIiwiYXJncyIsImdldE9zc0NsaWVudCIsInRodW1iIiwibmFtZTJVcmwiLCJpc09zc1VybCIsImlzTmVlZFNpZ25Pc3NVcmwiLCJnZXRSZWxhdGl2ZVBhdGhGcm9tVXJsIiwiZ2V0T3NzSW1hZ2VNSU1FIiwiY29uc3RydWN0b3IiLCJmaWxlIiwibXVsdGlwYXJ0VXBsb2FkIiwiY2h1bmtlZCIsInNpbXBsZVVwbG9hZCIsImdldEN1cnJlbnRPc3NDbGllbnRQcm9taXNlIiwiY3VycmVudE9zc0NsaWVudFByb21pc2UiLCJpbml0T3NzQ2xpZW50IiwiYWxpT3NzQ2xpZW50IiwiZXhwaXJhdGlvbiIsIkRhdGUiLCJub3ciLCJ1cGRhdGVPc3NDbGllbnQiLCJzZXRBbGlPc3NDbGllbnQiLCJvc3NDbGllbnRPcHRpb25zIiwiVHRPc3NPcHRpb25zMkFsaU9zc09wdGlvbnMiLCJPc3MiLCJpc1R0T3NzT3B0aW9uc1dpdGhGZXRjaCIsIm9zc0FwaUluZm8iLCJmZXRjaE9zc0luZm8iLCJvc3NBcGlJbmZvMk9zc0NsaWVudE9wdGlvbnMiLCJpc1R0T3NzT3B0aW9uc1dpdGhBcGkiLCJhY2Nlc3NLZXlJZCIsImFjY2Vzc0tleVNlY3JldCIsInJlZ2lvbklkIiwiYnVja2V0TmFtZSIsInNlY3VyaXR5VG9rZW4iLCJyZWdpb24iLCJidWNrZXQiLCJzdHNUb2tlbiJdLCJzb3VyY2VzIjpbIi4uL2xpYlNyYy9jbGFzcy50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgT3NzIGZyb20gJ2FsaS1vc3MnXG5pbXBvcnQgeyBUdE9zc09wdGlvbnMsIFR0T3NzT3B0aW9uc1dpdGhGZXRjaCwgVHRPc3NPcHRpb25zV2l0aEFwaSB9IGZyb20gJy4vdHlwaW5ncydcbmltcG9ydCB7IEFsaU9zc0luc3RhbmNlLCBPc3NBcGlJbmZvIH0gZnJvbSAnLi90eXBpbmdzJ1xuaW1wb3J0IHsgbXVsdGlwYXJ0VXBsb2FkIH0gZnJvbSAnLi9zcmMvbXVsdGlwYXJ0LXVwbG9hZCdcbmltcG9ydCB7IHNpbXBsZVVwbG9hZCB9IGZyb20gJy4vc3JjL3NpbXBsZS11cGxvYWQnXG5pbXBvcnQgeyB0aHVtYiB9IGZyb20gJy4vc3JjL3RodW1iJ1xuaW1wb3J0IHsgbmFtZTJVcmwgfSBmcm9tICcuL3NyYy9uYW1lLTItdXJsJ1xuaW1wb3J0IHsgaXNOZWVkU2lnbk9zc1VybCwgaXNPc3NVcmwgfSBmcm9tICcuL3NyYy9pcy1vc3MtdXJsJ1xuaW1wb3J0IHsgZ2V0UmVsYXRpdmVQYXRoRnJvbVVybCB9IGZyb20gJy4vc3JjL2dldC1yZWxhdGl2ZS1wYXRoLWZyb20tdXJsJ1xuaW1wb3J0IHsgZ2V0T3NzSW1hZ2VNSU1FIH0gZnJvbSAnLi9zcmMvaXMtc3VwcG9ydC13ZWJwJ1xuXG5leHBvcnQgY2xhc3MgUXdPc3Mge1xuICAvLyDljZXkvotcbiAgcHJpdmF0ZSBzdGF0aWMgZ2xvYmFsVHRPc3NJbnN0YW5jZTogUXdPc3MgfCB1bmRlZmluZWRcbiAgLy8gVHRPc3PnmoTphY3nva5cbiAgVHRPc3NPcHRpb25zITogVHRPc3NPcHRpb25zXG4gIC8vIGFsaS1vc3Plrp7kvotcbiAgYWxpT3NzQ2xpZW50ITogQWxpT3NzSW5zdGFuY2VcbiAgLy8g5o6n5Yi2cHJvbWlzZee8k+WtmCzmiYvliqjmjqfliLbmmK/lm6DkuLphbGktb3Nz5rKh5pyJ5YGacHJvbWlzZee8k+WtmO+8jOWkmuasoeWQjOaXtuivt+axguaXtuS8muivt+axguWkmuasoeaOpeWPo1xuICBwcml2YXRlIGN1cnJlbnRPc3NDbGllbnRQcm9taXNlPzogUHJvbWlzZTxBbGlPc3NJbnN0YW5jZT5cbiAgLy8g5o6n5Yi257yT5a2Y55qE5qCH6K+GXG4gIHByaXZhdGUgaXNVcGRhdGluZ09zc0NsaWVudCA9IGZhbHNlXG4gIC8qKlxuICAgKiBAZGVzY3JpcHRpb246IOWuieijheaWueazlVxuICAgKiBAcGFyYW0ge29wdGlvbnN9IOmFjee9rumhuVxuICAgKiBAcmV0dXJuIHtRd09zc30g5Y2V5L6LXG4gICAqL1xuICBzdGF0aWMgaW5zdGFsbChvcHRpb25zOiBUdE9zc09wdGlvbnMpIHtcbiAgICByZXR1cm4gbmV3IFF3T3NzKG9wdGlvbnMpXG4gIH1cbiAgLyoqXG4gICAqIEBkZXNjcmlwdGlvbjog6YeN5paw5a6J6KOF5pa55rOVLOebruWJjeS4u+imgeeUqOS6juS4muWKoeS+p+abtOaWsHN0c+S/oeaBr1xuICAgKiBAcmV0dXJuIHtRd09zc30g5paw55qE5Y2V5L6LXG4gICAqL1xuICBzdGF0aWMgcmVpbnN0YWxsKCkge1xuICAgIGNvbnN0IFR0T3NzT3B0aW9ucyA9IHRoaXMuZ2V0R2xvYmFsSW5zdGFuY2UoKS5UdE9zc09wdGlvbnNcbiAgICB0aGlzLmdsb2JhbFR0T3NzSW5zdGFuY2UgPSB1bmRlZmluZWRcbiAgICByZXR1cm4gbmV3IFF3T3NzKFR0T3NzT3B0aW9ucylcbiAgfVxuICAvKipcbiAgICogQGRlc2NyaXB0aW9uOiDojrflj5bljZXkvotcbiAgICogQHJldHVybiB7UXdPc3N9IOWNleS+i1xuICAgKi9cbiAgc3RhdGljIGdldEdsb2JhbEluc3RhbmNlKCkge1xuICAgIGlmICghdGhpcy5nbG9iYWxUdE9zc0luc3RhbmNlKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ+ivt+WFiOWIneWni+WMllR0T3NzJylcbiAgICB9XG4gICAgcmV0dXJuIHRoaXMuZ2xvYmFsVHRPc3NJbnN0YW5jZVxuICB9XG4gIC8qKlxuICAgKiBAZGVzY3JpcHRpb246IOS4muWKoeS4iuS8oFxuICAgKiBAcGFyYW0ge0ZpbGV9IGZpbGVcbiAgICogQHBhcmFtIHtvYmplY3R9IG9wdGlvbnNcbiAgICogQHJldHVybiB7UHJvbWlzZTxPc3NVcGxvYWRSZXNwb25zZT59XG4gICAqL1xuICBzdGF0aWMgdXBsb2FkKC4uLmFyZ3M6IFBhcmFtZXRlcnM8UXdPc3NbJ3VwbG9hZCddPikge1xuICAgIHJldHVybiB0aGlzLmdldEdsb2JhbEluc3RhbmNlKCkudXBsb2FkKC4uLmFyZ3MpXG4gIH1cbiAgLyoqXG4gICAqIEBkZXNjcmlwdGlvbjog6I635Y+WYWxpLW9zc+WunuS+i1xuICAgKiBAcmV0dXJuIHtQcm9taXNlPEFsaU9zc0luc3RhbmNlPn1cbiAgICovXG4gIHN0YXRpYyBnZXRPc3NDbGllbnQoKSB7XG4gICAgcmV0dXJuIHRoaXMuZ2V0R2xvYmFsSW5zdGFuY2UoKS5nZXRPc3NDbGllbnQoKVxuICB9XG4gIC8qKlxuICAgKiBAZGVzY3JpcHRpb246IOWvuXNyY+aIluiAhW9zc+eahG5hbWXov5vooYznrb7lkI3vvIzlubblop7liqDnvKnmlL7jgIHmoLzlvI/nrYnlj4LmlbDlubbnrb7lkI1cbiAgICogQHBhcmFtIHtzdHJpbmd9IHNyYyB1cmzmiJbogIVvc3PnmoRuYW1lXG4gICAqIEBwYXJhbSB7b2JqZWN0fSBvcHRpb25zIOmFjee9rumhuVxuICAgKiBAcmV0dXJuIHtQcm9taXNlPHN0cmluZz59IOetvuWQjeWQjueahHNyY1xuICAgKi9cbiAgc3RhdGljIHRodW1iKC4uLmFyZ3M6IFBhcmFtZXRlcnM8dHlwZW9mIHRodW1iPikge1xuICAgIHJldHVybiB0aHVtYiguLi5hcmdzKVxuICB9XG4gIC8qKlxuICAgKiBAZGVzY3JpcHRpb246IG9zc+i/lOWbnueahOaWh+S7tm5hbWXovazmjaLmiJB1cmxcbiAgICogQHBhcmFtIHtzdHJpbmd9IHNyYyBvc3PnmoRuYW1lXG4gICAqIEByZXR1cm4ge1Byb21pc2U8c3RyaW5nPn0g562+5ZCN5ZCO55qEc3JjXG4gICAqL1xuICBzdGF0aWMgbmFtZTJVcmwoLi4uYXJnczogUGFyYW1ldGVyczx0eXBlb2YgbmFtZTJVcmw+KSB7XG4gICAgcmV0dXJuIG5hbWUyVXJsKC4uLmFyZ3MpXG4gIH1cbiAgLy8g5piv5ZCm5pivb3Nz55qEdXJsXG4gIC8qKlxuICAgKiBAZGVzY3JpcHRpb246IG9zc+i/lOWbnueahOaWh+S7tm5hbWXovazmjaLmiJB1cmxcbiAgICogQHBhcmFtIHtzdHJpbmd9IHNyYyBvc3PnmoRuYW1lXG4gICAqIEByZXR1cm4ge1Byb21pc2U8c3RyaW5nPn0g562+5ZCN5ZCO55qEc3JjXG4gICAqL1xuICBzdGF0aWMgaXNPc3NVcmwoLi4uYXJnczogUGFyYW1ldGVyczx0eXBlb2YgaXNPc3NVcmw+KSB7XG4gICAgcmV0dXJuIGlzT3NzVXJsKC4uLmFyZ3MpXG4gIH1cbiAgLyoqXG4gICAqIEBkZXNjcmlwdGlvbjog5piv5ZCm5piv6ZyA6KaB562+5ZCN55qEdXJsXG4gICAqIEBwYXJhbSB7c3RyaW5nfSB1cmxcbiAgICogQHJldHVybiB7Ym9vbGVhbn1cbiAgICovXG4gIHN0YXRpYyBpc05lZWRTaWduT3NzVXJsKC4uLmFyZ3M6IFBhcmFtZXRlcnM8dHlwZW9mIGlzTmVlZFNpZ25Pc3NVcmw+KSB7XG4gICAgcmV0dXJuIGlzTmVlZFNpZ25Pc3NVcmwoLi4uYXJncylcbiAgfVxuICAvKipcbiAgICogQGRlc2NyaXB0aW9uOiDmiKrlj5Zvc3PnmoR1cmzvvIzlj6rkv53nlZluYW1lXG4gICAqIEBwYXJhbSB7c3RyaW5nfSB1cmxcbiAgICogQHJldHVybiB7c3RyaW5nfVxuICAgKi9cbiAgc3RhdGljIGdldFJlbGF0aXZlUGF0aEZyb21VcmwoLi4uYXJnczogUGFyYW1ldGVyczx0eXBlb2YgZ2V0UmVsYXRpdmVQYXRoRnJvbVVybD4pIHtcbiAgICByZXR1cm4gZ2V0UmVsYXRpdmVQYXRoRnJvbVVybCguLi5hcmdzKVxuICB9XG4gIC8vIOiOt+WPlm9zc+eahGltYWdlTUlNRe+8jOaUr+aMgXdlYnDmoLzlvI/lsLHov5Tlm553ZWJwXG4gIHN0YXRpYyBnZXRPc3NJbWFnZU1JTUUoLi4uYXJnczogUGFyYW1ldGVyczx0eXBlb2YgZ2V0T3NzSW1hZ2VNSU1FPikge1xuICAgIHJldHVybiBnZXRPc3NJbWFnZU1JTUUoLi4uYXJncylcbiAgfVxuICBjb25zdHJ1Y3RvcihvcHRpb25zOiBUdE9zc09wdGlvbnMpIHtcbiAgICBpZiAoUXdPc3MuZ2xvYmFsVHRPc3NJbnN0YW5jZSkgcmV0dXJuIFF3T3NzLmdsb2JhbFR0T3NzSW5zdGFuY2VcbiAgICB0aGlzLlR0T3NzT3B0aW9ucyA9IG9wdGlvbnNcbiAgICBRd09zcy5nbG9iYWxUdE9zc0luc3RhbmNlID0gdGhpc1xuICB9XG4gIC8qKlxuICAgKiBAZGVzY3JpcHRpb246IOS4muWKoeS4iuS8oO+8iOWunuS+i+aWueazle+8iVxuICAgKiBAcGFyYW0ge0ZpbGV9IGZpbGVcbiAgICogQHBhcmFtIHtvYmplY3R9IG9wdGlvbnNcbiAgICogQHJldHVybiB7UHJvbWlzZTxPc3NVcGxvYWRSZXNwb25zZT59XG4gICAqL1xuICB1cGxvYWQoZmlsZTogRmlsZSwgb3B0aW9ucz86IChQYXJhbWV0ZXJzPHR5cGVvZiBzaW1wbGVVcGxvYWQ+WzFdIHwgUGFyYW1ldGVyczx0eXBlb2YgbXVsdGlwYXJ0VXBsb2FkPlsxXSkgJiB7IGNodW5rPzogYm9vbGVhbiB9KSB7XG4gICAgaWYgKCFvcHRpb25zKSByZXR1cm4gbXVsdGlwYXJ0VXBsb2FkKGZpbGUpXG4gICAgZWxzZSBpZiAoJ2NodW5rZWQnIGluIG9wdGlvbnMpIHtcbiAgICAgIGlmIChvcHRpb25zLmNodW5rZWQpIHJldHVybiBtdWx0aXBhcnRVcGxvYWQoZmlsZSwgb3B0aW9ucylcbiAgICAgIGVsc2UgcmV0dXJuIHNpbXBsZVVwbG9hZChmaWxlLCBvcHRpb25zKVxuICAgIH0gZWxzZSByZXR1cm4gbXVsdGlwYXJ0VXBsb2FkKGZpbGUsIG9wdGlvbnMpXG4gIH1cbiAgLyoqXG4gICAqIEBkZXNjcmlwdGlvbjog6I635Y+WYWxpLW9zc+WunuS+i++8iOWunuS+i+aWueazle+8iVxuICAgKiBAcmV0dXJuIHtQcm9taXNlPEFsaU9zc0luc3RhbmNlPn1cbiAgICovXG4gIGdldE9zc0NsaWVudCgpIHtcbiAgICBjb25zdCBnZXRDdXJyZW50T3NzQ2xpZW50UHJvbWlzZSA9IGFzeW5jICgpID0+IHtcbiAgICAgIGlmICghdGhpcy5jdXJyZW50T3NzQ2xpZW50UHJvbWlzZSkge1xuICAgICAgICB0aGlzLmluaXRPc3NDbGllbnQoKVxuICAgICAgICAvLyDljp/mnKzpgLvovpHmmK8zMOenkuWGl+S9meaXtumXtO+8jOS9huaYr+WPkeeOsOaOpeWPo+eahGV4cGlyYXRpb27kuI3mmK/mr4/mrKHor7fmsYLliLfmlrDvvIzmiYDku6XmlLnkuLrku6XkuIvpgLvovpFcbiAgICAgIH0gZWxzZSBpZiAodGhpcy5hbGlPc3NDbGllbnQ/Lm9wdGlvbnM/LmV4cGlyYXRpb24hIDwgRGF0ZS5ub3coKSkge1xuICAgICAgICB0aGlzLnVwZGF0ZU9zc0NsaWVudCgpXG4gICAgICB9XG4gICAgICByZXR1cm4gdGhpcy5jdXJyZW50T3NzQ2xpZW50UHJvbWlzZSFcbiAgICB9XG4gICAgcmV0dXJuIGdldEN1cnJlbnRPc3NDbGllbnRQcm9taXNlKClcbiAgfVxuXG4gIC8vIOiuvue9rmFsaS1vc3Plrp7kvotcbiAgcHJpdmF0ZSBhc3luYyBzZXRBbGlPc3NDbGllbnQoKSB7XG4gICAgY29uc3Qgb3NzQ2xpZW50T3B0aW9ucyA9IGF3YWl0IHRoaXMuVHRPc3NPcHRpb25zMkFsaU9zc09wdGlvbnMoKVxuICAgIHRoaXMuYWxpT3NzQ2xpZW50ID0gbmV3IE9zcyhvc3NDbGllbnRPcHRpb25zKVxuICAgIHRoaXMuaXNVcGRhdGluZ09zc0NsaWVudCA9IGZhbHNlXG4gICAgcmV0dXJuIHRoaXMuYWxpT3NzQ2xpZW50XG4gIH1cbiAgLy8g56ys5LiA5qyh5Yid5aeL5YyWXG4gIHByaXZhdGUgaW5pdE9zc0NsaWVudCgpIHtcbiAgICBpZiAodGhpcy5pc1VwZGF0aW5nT3NzQ2xpZW50KSByZXR1cm5cbiAgICB0aGlzLmlzVXBkYXRpbmdPc3NDbGllbnQgPSB0cnVlXG4gICAgdGhpcy5jdXJyZW50T3NzQ2xpZW50UHJvbWlzZSA9IHRoaXMuc2V0QWxpT3NzQ2xpZW50KClcbiAgfVxuICAvLyDlkI7nu63ov4fmnJ/liKTmlq1cbiAgcHJpdmF0ZSB1cGRhdGVPc3NDbGllbnQoKSB7XG4gICAgaWYgKHRoaXMuaXNVcGRhdGluZ09zc0NsaWVudCkgcmV0dXJuXG4gICAgdGhpcy5pc1VwZGF0aW5nT3NzQ2xpZW50ID0gdHJ1ZVxuICAgIHRoaXMuY3VycmVudE9zc0NsaWVudFByb21pc2UgPSB0aGlzLnNldEFsaU9zc0NsaWVudCgpXG4gIH1cbiAgLy8gVHRPc3PphY3nva7pobk9PmFsaS1vc3PphY3nva7poblcbiAgYXN5bmMgVHRPc3NPcHRpb25zMkFsaU9zc09wdGlvbnMoKSB7XG4gICAgaWYgKHRoaXMuaXNUdE9zc09wdGlvbnNXaXRoRmV0Y2godGhpcy5UdE9zc09wdGlvbnMpKSB7XG4gICAgICBjb25zdCBvc3NBcGlJbmZvID0gYXdhaXQgdGhpcy5UdE9zc09wdGlvbnMuZmV0Y2hPc3NJbmZvKClcbiAgICAgIGNvbnN0IG9zc0NsaWVudE9wdGlvbnMgPSB0aGlzLm9zc0FwaUluZm8yT3NzQ2xpZW50T3B0aW9ucyhvc3NBcGlJbmZvKVxuICAgICAgcmV0dXJuIG9zc0NsaWVudE9wdGlvbnNcbiAgICB9IGVsc2UgaWYgKHRoaXMuaXNUdE9zc09wdGlvbnNXaXRoQXBpKHRoaXMuVHRPc3NPcHRpb25zKSkge1xuICAgICAgY29uc3Qgb3NzQ2xpZW50T3B0aW9ucyA9IHRoaXMub3NzQXBpSW5mbzJPc3NDbGllbnRPcHRpb25zKHRoaXMuVHRPc3NPcHRpb25zKVxuICAgICAgcmV0dXJuIG9zc0NsaWVudE9wdGlvbnNcbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIHRoaXMuVHRPc3NPcHRpb25zXG4gICAgfVxuICB9XG4gIC8vIOaOpeWPo29zc+S/oeaBrz0+5YmN56uv6ZyA6KaB55qE5L+h5oGvXG4gIG9zc0FwaUluZm8yT3NzQ2xpZW50T3B0aW9ucyhvc3NBcGlJbmZvOiBPc3NBcGlJbmZvKSB7XG4gICAgY29uc3QgeyBhY2Nlc3NLZXlJZCwgYWNjZXNzS2V5U2VjcmV0LCByZWdpb25JZCwgYnVja2V0TmFtZSwgc2VjdXJpdHlUb2tlbiwgZXhwaXJhdGlvbiB9ID0gb3NzQXBpSW5mb1xuICAgIHJldHVybiB7XG4gICAgICBleHBpcmF0aW9uLCAvLyDmjqXlj6Pov5Tlm57vvIxhbGktb3Nz5LiN6ZyA6KaBXG4gICAgICBhY2Nlc3NLZXlJZCxcbiAgICAgIGFjY2Vzc0tleVNlY3JldCxcbiAgICAgIHJlZ2lvbjogYG9zcy0ke3JlZ2lvbklkfWAsXG4gICAgICBidWNrZXQ6IGJ1Y2tldE5hbWUsXG4gICAgICBzdHNUb2tlbjogc2VjdXJpdHlUb2tlblxuICAgIH1cbiAgfVxuICBwcml2YXRlIGlzVHRPc3NPcHRpb25zV2l0aEZldGNoKG9wdGlvbnM6IFR0T3NzT3B0aW9ucyk6IG9wdGlvbnMgaXMgVHRPc3NPcHRpb25zV2l0aEZldGNoIHtcbiAgICByZXR1cm4gISEob3B0aW9ucyBhcyBUdE9zc09wdGlvbnNXaXRoRmV0Y2gpLmZldGNoT3NzSW5mb1xuICB9XG5cbiAgcHJpdmF0ZSBpc1R0T3NzT3B0aW9uc1dpdGhBcGkob3B0aW9uczogVHRPc3NPcHRpb25zKTogb3B0aW9ucyBpcyBUdE9zc09wdGlvbnNXaXRoQXBpIHtcbiAgICByZXR1cm4gISEob3B0aW9ucyBhcyBUdE9zc09wdGlvbnNXaXRoQXBpKS5zZWN1cml0eVRva2VuXG4gIH1cbn1cbiJdLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBQUE7QUFHQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUF1RDtBQUVoRCxNQUFNQSxLQUFLLENBQUM7RUFDakI7O0VBRUE7O0VBRUE7O0VBRUE7O0VBRUE7RUFDUUMsbUJBQW1CLEdBQUcsS0FBSztFQUNuQztBQUNGO0FBQ0E7QUFDQTtBQUNBO0VBQ0UsT0FBT0MsT0FBTyxDQUFDQyxPQUFxQixFQUFFO0lBQ3BDLE9BQU8sSUFBSUgsS0FBSyxDQUFDRyxPQUFPLENBQUM7RUFDM0I7RUFDQTtBQUNGO0FBQ0E7QUFDQTtFQUNFLE9BQU9DLFNBQVMsR0FBRztJQUNqQixNQUFNQyxZQUFZLEdBQUcsSUFBSSxD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